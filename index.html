<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inserts paper generator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
        .preview-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .preview-scroll::-webkit-scrollbar-track {
            background: #e5e7eb; 
        }
        .preview-scroll::-webkit-scrollbar-thumb {
            background: #9ca3af; 
            border-radius: 4px;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Constants ---
        const PAPER_SIZES = {
            'a4': { name: 'A4', width: 210, height: 297 },
            'a5': { name: 'A5', width: 148, height: 210 },
            'b4': { name: 'B4 (JIS)', width: 257, height: 364 },
            'b5': { name: 'B5 (JIS)', width: 182, height: 257 },
            'letter': { name: 'Letter', width: 216, height: 279 },
            'postcard': { name: '„Éè„Ç¨„Ç≠', width: 100, height: 148 }
        };

        const MM_TO_PX = 3.7795;

        const DEFAULT_SETTINGS = {
            paperSize: 'a4',
            targetHeight: 90, // mm (9cm)
            targetWidth: 25,  // mm (2.5cm)
            margin: 3,        // mm (0.3cm)
            gap: 2,           // mm (0.2cm)
            showGuides: true,
            unit: 'cm',
            ignoreAspectRatio: false
        };

        // --- Icons ---
        const TrashIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
        );

        const FileIcon = () => (
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
        );

        const DownloadIcon = () => (
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
        );

        const LoaderIcon = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );
        
        const RotateIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        );

        const RefreshIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        );

        const DragHandleIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8h16M4 16h16"></path>
            </svg>
        );


        // --- Components ---

        const NumberStepper = ({ value, onChange, step, min = 0, unitLabel, disabled = false, defaultValue }) => {
            const [localValue, setLocalValue] = useState(value);
            const [isFocused, setIsFocused] = useState(false);

            useEffect(() => {
                if (!isFocused && parseFloat(localValue) !== value) {
                    setLocalValue(value);
                }
            }, [value, isFocused]);

            const handleChange = (e) => {
                const val = e.target.value;
                setLocalValue(val);
                
                if (val === '' || isNaN(parseFloat(val))) {
                    onChange(defaultValue);
                } else {
                    onChange(parseFloat(val));
                }
            };

            const handleBlur = () => {
                setIsFocused(false);
                if (localValue === '' || isNaN(parseFloat(localValue))) {
                    setLocalValue(defaultValue);
                    onChange(defaultValue);
                } else {
                    const num = Math.max(min, parseFloat(localValue));
                    setLocalValue(num);
                    onChange(num);
                }
            };

            const handleFocus = () => {
                setIsFocused(true);
            };

            const handleDecrement = () => {
                if(disabled) return;
                const current = (localValue === '' || isNaN(parseFloat(localValue))) ? defaultValue : parseFloat(localValue);
                const stepNum = parseFloat(step) || 1;
                let newVal = current - stepNum;
                if (newVal < min) newVal = min;
                const precision = step.toString().split('.')[1]?.length || 0;
                const finalVal = Number(newVal.toFixed(precision));
                setLocalValue(finalVal);
                onChange(finalVal);
            };

            const handleIncrement = () => {
                if(disabled) return;
                const current = (localValue === '' || isNaN(parseFloat(localValue))) ? defaultValue : parseFloat(localValue);
                const stepNum = parseFloat(step) || 1;
                const newVal = current + stepNum;
                const precision = step.toString().split('.')[1]?.length || 0;
                const finalVal = Number(newVal.toFixed(precision));
                setLocalValue(finalVal);
                onChange(finalVal);
            };

            return (
                <div className={`flex items-center w-full border rounded overflow-hidden shadow-sm transition-colors ${disabled ? 'bg-gray-100 border-gray-200 opacity-60' : 'bg-white border-gray-300 focus-within:ring-2 focus-within:ring-blue-500'}`}>
                    <button type="button" onClick={handleDecrement} disabled={disabled} className="w-10 h-10 flex items-center justify-center bg-gray-50 text-gray-500 hover:bg-gray-200 border-r border-gray-300 transition-colors focus:outline-none disabled:cursor-not-allowed">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <input 
                        type="number" 
                        step={step} 
                        min={min} 
                        value={localValue} 
                        onChange={handleChange} 
                        onBlur={handleBlur}
                        onFocus={handleFocus}
                        disabled={disabled}
                        className="w-full h-10 text-center text-gray-700 font-medium focus:outline-none bg-transparent disabled:cursor-not-allowed" 
                    />
                    <button type="button" onClick={handleIncrement} disabled={disabled} className="w-10 h-10 flex items-center justify-center bg-gray-50 text-gray-500 hover:bg-gray-200 border-l border-gray-300 transition-colors focus:outline-none disabled:cursor-not-allowed">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    {unitLabel && <div className="bg-gray-100 border-l border-gray-300 px-2 h-10 flex items-center justify-center text-xs text-gray-500 w-10 flex-shrink-0 font-medium select-none">{unitLabel}</div>}
                </div>
            );
        };

        // „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅßÈ†ÜÁï™„ÇíÂÖ•„ÇåÊõø„Åà„Çâ„Çå„Çã„Éó„É¨„Éì„É•„ÉºÁîªÂÉè
        const PreviewImage = ({ item, settings, previewScale, MM_TO_PX, onRotate, onRemove, onDragStart, onDragOver, onDrop, draggedIndex }) => {
            const finalX = item.baseX + settings.margin;
            const finalY = item.baseY + settings.margin;
            const isBeingDragged = draggedIndex === item.originalIndex;

            return (
                <div 
                    draggable
                    onDragStart={(e) => onDragStart(e, item.originalIndex)}
                    onDragOver={(e) => onDragOver(e, item.originalIndex)}
                    onDrop={(e) => onDrop(e, item.originalIndex)}
                    className={`absolute group transition-shadow duration-300 ${isBeingDragged ? 'z-50 shadow-2xl opacity-50' : 'z-10 cursor-grab hover:z-40'}`}
                    style={{
                        left: `${finalX * MM_TO_PX}px`,
                        top: `${finalY * MM_TO_PX}px`,
                        width: `${item.w * MM_TO_PX}px`,
                        height: `${item.h * MM_TO_PX}px`,
                        transition: isBeingDragged ? 'none' : 'left 0.3s ease, top 0.3s ease', // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÁßªÂãï
                    }}
                >
                    <img 
                        src={item.preview} 
                        className="w-full h-full bg-gray-50 pointer-events-none"
                        style={{
                            objectFit: settings.ignoreAspectRatio ? 'fill' : 'contain',
                            outline: settings.showGuides ? '1px dashed #cbd5e1' : 'none',
                        }}
                    />
                    <div className="absolute top-0 right-0 p-1 flex gap-1 transition-opacity opacity-100 md:opacity-0 md:group-hover:opacity-100">
                        <button onClick={(e) => { e.stopPropagation(); onRotate(item.id); }} className="bg-white/90 text-gray-600 rounded shadow p-1 hover:text-blue-600 hover:bg-white transform active:scale-95 z-10" title="ÂõûËª¢"><RotateIcon /></button>
                        <button onClick={(e) => { e.stopPropagation(); onRemove(item.id); }} className="bg-red-500/90 text-white rounded shadow p-1 hover:bg-red-600 transform active:scale-95 z-10" title="ÂâäÈô§"><TrashIcon /></button>
                    </div>
                </div>
            );
        };


        const App = () => {
            const [images, setImages] = useState([]);
            const [isFileDragging, setIsFileDragging] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            
            // „É™„Çπ„Éà„Åä„Çà„Å≥„Éó„É¨„Éì„É•„Éº„Åß„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆÁîªÂÉè„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
            const [draggedIndex, setDraggedIndex] = useState(null);
            
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);

            const [previewScale, setPreviewScale] = useState(1);
            const previewContainerRef = useRef(null);

            const currentPaper = PAPER_SIZES[settings.paperSize];

            const toDisplay = (valMm) => settings.unit === 'cm' ? parseFloat((valMm / 10).toFixed(2)) : Math.round(valMm);
            const fromDisplay = (val) => settings.unit === 'cm' ? val * 10 : val;

            const handleSettingChange = (key, displayValue) => {
                const numVal = parseFloat(displayValue);
                if (isNaN(numVal)) return;
                setSettings(prev => ({ ...prev, [key]: fromDisplay(numVal) }));
            };

            const toggleUnit = () => {
                setSettings(prev => ({ ...prev, unit: prev.unit === 'mm' ? 'cm' : 'mm' }));
            };

            const resetSettings = () => {
                if(confirm('„É¨„Ç§„Ç¢„Ç¶„ÉàË®≠ÂÆö„ÇíÂàùÊúüÂÄ§„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) {
                    setSettings(prev => ({
                        ...DEFAULT_SETTINGS,
                        unit: prev.unit
                    }));
                }
            };

            const clearImages = () => {
                if(confirm('„Åô„Åπ„Å¶„ÅÆÁîªÂÉè„ÇíÊ∂àÂéª„Åó„Åæ„Åô„ÅãÔºü')) {
                    images.forEach(img => {
                        if (img.preview.startsWith('blob:')) URL.revokeObjectURL(img.preview);
                    });
                    setImages([]);
                }
            };

            // Responsive Scaling Logic
            useEffect(() => {
                const calculateScale = () => {
                    if (!previewContainerRef.current) return;
                    const containerWidth = previewContainerRef.current.clientWidth;
                    const padding = window.innerWidth < 768 ? 32 : 64; 
                    const availableWidth = containerWidth - padding;
                    const paperWidthPx = currentPaper.width * MM_TO_PX;
                    
                    let newScale = availableWidth / paperWidthPx;
                    if (newScale > 1) newScale = 1; 
                    
                    setPreviewScale(newScale);
                };

                calculateScale();
                window.addEventListener('resize', calculateScale);
                return () => window.removeEventListener('resize', calculateScale);
            }, [currentPaper, settings.paperSize]); 

            // CanvasHelper: Rotate Image
            const createRotatedImage = (imgSource, angle = 90) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const isPortrait = angle % 180 === 0;
                    if (isPortrait) {
                         canvas.width = imgSource.width;
                         canvas.height = imgSource.height;
                    } else {
                         canvas.width = imgSource.height;
                         canvas.height = imgSource.width;
                    }
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(angle * Math.PI / 180);
                    ctx.drawImage(imgSource, -imgSource.width / 2, -imgSource.height / 2);
                    resolve({
                        preview: canvas.toDataURL('image/jpeg', 0.90),
                        width: canvas.width,
                        height: canvas.height
                    });
                });
            };

            const handleFiles = async (files) => {
                const fileList = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (fileList.length === 0) return;

                const loadedImages = await Promise.all(fileList.map(file => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        const rawUrl = URL.createObjectURL(file);
                        
                        img.onload = async () => {
                            let resultPreview = rawUrl;
                            let resultW = img.naturalWidth;
                            let resultH = img.naturalHeight;

                            if (resultW > resultH) {
                                const rotated = await createRotatedImage(img, 90);
                                resultPreview = rotated.preview;
                                resultW = rotated.width;
                                resultH = rotated.height;
                                URL.revokeObjectURL(rawUrl); 
                            }

                            resolve({
                                file,
                                id: Math.random().toString(36).substr(2, 9),
                                preview: resultPreview,
                                name: file.name,
                                width: resultW,
                                height: resultH,
                                aspectRatio: resultW / resultH
                            });
                        };
                        img.src = rawUrl;
                    });
                }));
                
                setImages(prev => [...prev, ...loadedImages]);
            };

            const rotateImage = async (id) => {
                const targetIndex = images.findIndex(img => img.id === id);
                if (targetIndex === -1) return;
                const targetImg = images[targetIndex];
                const imgObj = new Image();
                imgObj.src = targetImg.preview;
                await new Promise(r => imgObj.onload = r);
                const rotated = await createRotatedImage(imgObj, 90);
                setImages(prev => {
                    const next = [...prev];
                    next[targetIndex] = {
                        ...targetImg,
                        preview: rotated.preview,
                        width: rotated.width,
                        height: rotated.height,
                        aspectRatio: rotated.width / rotated.height
                    };
                    return next;
                });
            };

            const removeImage = (id) => {
                setImages(prev => {
                    const target = prev.find(img => img.id === id);
                    if (target && target.preview.startsWith('blob:')) URL.revokeObjectURL(target.preview);
                    return prev.filter(img => img.id !== id);
                });
            };

            // --- Drag & Drop (‰∏¶„Å≥Êõø„Åà) ---
            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetIndex) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === targetIndex) return;

                setImages(prev => {
                    const newImages = [...prev];
                    const [removed] = newImages.splice(draggedIndex, 1);
                    newImages.splice(targetIndex, 0, removed);
                    return newImages;
                });
                setDraggedIndex(null);
            };

            // --- Layout Calculation ---
            const layoutPages = useMemo(() => {
                const pageW = currentPaper.width;
                const pageH = currentPaper.height;
                const margin = settings.margin;
                const gap = settings.gap;
                const targetH = settings.targetHeight;
                const targetW = settings.targetWidth;

                const contentW = pageW - (margin * 2);
                const contentH = pageH - (margin * 2);

                let pages = [];
                let currentPageItems = [];
                let currentX = 0;
                let currentY = 0;

                const finalizePage = () => {
                    if (currentPageItems.length > 0) {
                        pages.push(currentPageItems);
                    }
                    currentPageItems = [];
                    currentX = 0;
                    currentY = 0;
                };

                images.forEach((img, index) => {
                    const printH = targetH;
                    const printW = settings.ignoreAspectRatio ? targetW : (targetH * img.aspectRatio);

                    if (currentX + printW > contentW && currentX > 0) {
                        currentX = 0;
                        currentY += targetH + gap;
                    }

                    if (currentY + targetH > contentH) {
                        finalizePage();
                    }

                    currentPageItems.push({
                        ...img,
                        originalIndex: index, // ‰∏¶„Å≥Êõø„Åà„ÅÆÂèÇÁÖßÁî®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
                        baseX: currentX,
                        baseY: currentY,
                        w: printW,
                        h: printH
                    });

                    currentX += printW + gap;
                });

                if (currentPageItems.length > 0) {
                    pages.push(currentPageItems);
                }

                return pages;
            }, [images, settings, currentPaper]);


            const generatePDF = async () => {
                if (images.length === 0) return;
                setIsGenerating(true);

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'p',
                        unit: 'mm',
                        format: [currentPaper.width, currentPaper.height] 
                    });

                    const margin = settings.margin;

                    for (let pIndex = 0; pIndex < layoutPages.length; pIndex++) {
                        const pageItems = layoutPages[pIndex];
                        if (pIndex > 0) {
                             doc.addPage([currentPaper.width, currentPaper.height]);
                        }

                        for (const item of pageItems) {
                            const imgObj = await new Promise((resolve) => {
                                const img = new Image();
                                img.onload = () => resolve(img);
                                img.src = item.preview;
                            });

                            const canvas = document.createElement('canvas');
                            canvas.width = imgObj.width;
                            canvas.height = imgObj.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(imgObj, 0, 0);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.90);

                            const finalX = item.baseX + margin;
                            const finalY = item.baseY + margin;

                            doc.addImage(
                                dataUrl, 
                                'JPEG', 
                                finalX, 
                                finalY, 
                                item.w, 
                                item.h
                            );
                        }
                    }

                    doc.save(`layout_${settings.paperSize}.pdf`);

                } catch (e) {
                    console.error(e);
                    alert("PDF‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
                } finally {
                    setIsGenerating(false);
                }
            };

            const displayUnit = settings.unit;

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto p-2 md:p-4 gap-4 md:gap-6">
                    
                    {/* Controls */}
                    <div className="w-full md:w-[360px] flex flex-col gap-4 md:gap-6 bg-white p-4 md:p-5 rounded-xl shadow-sm border border-gray-200 h-fit md:sticky md:top-4 z-20">
                        <header>
                            <h1 className="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                                <FileIcon />
                                „Ç§„É≥„Çµ„Éº„ÉàPDF‰ΩúÊàê
                            </h1>
                        </header>

                        {/* Settings */}
                        <div className="space-y-4 border-t pt-4 border-gray-100">
                            <div className="flex justify-between items-center mb-2">
                                <h2 className="text-sm font-bold text-gray-700">„É¨„Ç§„Ç¢„Ç¶„ÉàË®≠ÂÆö</h2>
                                <div className="flex gap-2">
                                    <button onClick={resetSettings} className="text-xs flex items-center gap-1 bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 font-medium transition" title="„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„Å´Êàª„Åô">
                                        <RefreshIcon className="w-3 h-3"/> „É™„Çª„ÉÉ„Éà
                                    </button>
                                    <button onClick={toggleUnit} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 font-medium transition">
                                        Âçò‰Ωç: {settings.unit}
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-600 mb-1">Áî®Á¥ô„Çµ„Ç§„Ç∫</label>
                                <div className="relative">
                                    <select 
                                        value={settings.paperSize}
                                        onChange={(e) => setSettings(p => ({...p, paperSize: e.target.value}))}
                                        className="w-full h-10 pl-3 pr-8 border border-gray-300 rounded bg-white text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none cursor-pointer"
                                    >
                                        {Object.entries(PAPER_SIZES).map(([key, size]) => (
                                            <option key={key} value={key}>
                                                {size.name} ({size.width}√ó{size.height}mm)
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-blue-50/50 p-3 rounded border border-blue-100/50 space-y-3">
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 mb-1">ÁîªÂÉè„ÅÆÈ´ò„Åï (Á∏¶ÂπÖ)</label>
                                    <NumberStepper 
                                        value={toDisplay(settings.targetHeight)}
                                        onChange={(val) => handleSettingChange('targetHeight', val)}
                                        step={displayUnit === 'cm' ? "0.1" : "1"}
                                        min={1}
                                        unitLabel={displayUnit}
                                        defaultValue={displayUnit === 'cm' ? 9.0 : 90}
                                    />
                                </div>

                                <div className="pt-1">
                                    <label className="flex items-center gap-2 cursor-pointer mb-2">
                                        <input 
                                            type="checkbox" 
                                            checked={settings.ignoreAspectRatio} 
                                            onChange={(e) => setSettings(p => ({...p, ignoreAspectRatio: e.target.checked}))} 
                                            className="rounded text-blue-600 focus:ring-blue-500 w-4 h-4" 
                                        />
                                        <span className="text-sm font-bold text-gray-700">„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÁÑ°Ë¶ñ„Åó„Å¶Ê®™ÂπÖ„ÇíÊåáÂÆö</span>
                                    </label>

                                    <div className={`transition-opacity pl-6 ${settings.ignoreAspectRatio ? 'opacity-100' : 'opacity-50 pointer-events-none'}`}>
                                        <div className="flex justify-between items-end mb-1">
                                            <label className="block text-sm font-medium text-gray-600">ÁîªÂÉè„ÅÆÊ®™ÂπÖ</label>
                                            <div className="flex gap-1">
                                                <button 
                                                    onClick={() => setSettings(p => ({...p, targetWidth: 25}))}
                                                    className="text-xs bg-white border border-gray-300 shadow-sm hover:bg-gray-50 text-gray-700 px-2 py-1 rounded transition-colors"
                                                >G3 (2.5cm)</button>
                                                <button 
                                                    onClick={() => setSettings(p => ({...p, targetWidth: 22}))}
                                                    className="text-xs bg-white border border-gray-300 shadow-sm hover:bg-gray-50 text-gray-700 px-2 py-1 rounded transition-colors"
                                                >rsvp (2.2cm)</button>
                                            </div>
                                        </div>
                                        <NumberStepper 
                                            value={toDisplay(settings.targetWidth)}
                                            onChange={(val) => handleSettingChange('targetWidth', val)}
                                            step={displayUnit === 'cm' ? "0.1" : "1"}
                                            min={1}
                                            unitLabel={displayUnit}
                                            disabled={!settings.ignoreAspectRatio}
                                            defaultValue={displayUnit === 'cm' ? 2.5 : 25}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 mb-1">‰ΩôÁôΩ</label>
                                    <NumberStepper 
                                        value={toDisplay(settings.margin)}
                                        onChange={(val) => handleSettingChange('margin', val)}
                                        step={displayUnit === 'cm' ? "0.1" : "1"}
                                        min={0}
                                        unitLabel={displayUnit}
                                        defaultValue={displayUnit === 'cm' ? 0.3 : 3}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 mb-1">ÈñìÈöî</label>
                                    <NumberStepper 
                                        value={toDisplay(settings.gap)}
                                        onChange={(val) => handleSettingChange('gap', val)}
                                        step={displayUnit === 'cm' ? "0.1" : "1"}
                                        min={0}
                                        unitLabel={displayUnit}
                                        defaultValue={displayUnit === 'cm' ? 0.2 : 2}
                                    />
                                </div>
                            </div>

                            <div className="pt-2">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked={settings.showGuides} onChange={(e) => setSettings(p => ({...p, showGuides: e.target.checked}))} className="rounded text-blue-600 focus:ring-blue-500" />
                                    <span className="text-sm text-gray-600">Êû†Á∑ö„ÇíË°®Á§∫</span>
                                </label>
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="space-y-3 pt-2">
                            <label className={`
                                flex items-center justify-center w-full p-3 rounded-lg border-2 border-dashed cursor-pointer transition-colors
                                ${isFileDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400 hover:bg-gray-50'}
                            `}
                            onDragOver={(e) => { e.preventDefault(); setIsFileDragging(true); }}
                            onDragLeave={(e) => { e.preventDefault(); setIsFileDragging(false); }}
                            onDrop={(e) => { e.preventDefault(); setIsFileDragging(false); handleFiles(e.dataTransfer.files); }}
                            >
                                <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleFiles(e.target.files)} />
                                <div className="text-center">
                                    <span className="text-sm font-medium text-gray-600 block">ÂÜôÁúü„ÇíËøΩÂä†</span>
                                    <span className="text-xs text-gray-400">„ÇØ„É™„ÉÉ„ÇØ „Åæ„Åü„ÅØ „Éâ„É©„ÉÉ„Ç∞</span>
                                </div>
                            </label>

                            <button 
                                onClick={generatePDF}
                                disabled={images.length === 0 || isGenerating}
                                className={`
                                    w-full py-3 px-4 rounded-lg font-bold text-white flex items-center justify-center shadow-md transition-all
                                    ${images.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 active:scale-[0.98]'}
                                `}
                            >
                                {isGenerating ? <LoaderIcon /> : <DownloadIcon />}
                                {isGenerating ? 'ÁîüÊàê‰∏≠...' : 'PDF„Çí‰ΩúÊàê'}
                            </button>
                        </div>
                        
                        {/* File List */}
                        <div className="flex-1 overflow-y-auto max-h-[250px] md:max-h-none md:min-h-[100px] border-t pt-4">
                             <div className="flex justify-between items-center mb-2">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">ÁîªÂÉè‰∏ÄË¶ß ({images.length})</h3>
                                {images.length > 0 && (
                                    <button onClick={clearImages} className="text-xs flex items-center gap-1 bg-red-50 text-red-500 hover:bg-red-100 px-2 py-1 rounded transition">
                                        <TrashIcon className="w-3 h-3" /> ÂÖ®Ê∂àÂéª
                                    </button>
                                )}
                             </div>
                             {images.length > 0 && <p className="text-[10px] text-gray-400 mb-2">‚Äª„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅßÈ†ÜÁï™„ÇíÂÖ•„ÇåÊõø„Åà„Çâ„Çå„Åæ„Åô</p>}
                             <div className="space-y-2 pb-2">
                                {images.map((img, index) => (
                                    <div 
                                        key={img.id} 
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, index)}
                                        onDragOver={(e) => handleDragOver(e, index)}
                                        onDrop={(e) => handleDrop(e, index)}
                                        className={`flex items-center gap-3 bg-gray-50 p-2 rounded border group cursor-move hover:bg-gray-100 transition-colors ${draggedIndex === index ? 'opacity-50 border-blue-400' : 'border-gray-100'}`}
                                    >
                                        <div className="text-gray-400 cursor-grab active:cursor-grabbing">
                                            <DragHandleIcon />
                                        </div>
                                        <img src={img.preview} alt="" className="w-8 h-8 object-cover rounded bg-white pointer-events-none" />
                                        <div className="flex-1 min-w-0">
                                            <p className="text-xs text-gray-700 truncate">{img.name}</p>
                                        </div>
                                        <div className="flex gap-1 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => rotateImage(img.id)} className="text-gray-400 hover:text-blue-500 p-1" title="ÂõûËª¢"><RotateIcon /></button>
                                            <button onClick={() => removeImage(img.id)} className="text-gray-400 hover:text-red-500 p-1" title="ÂâäÈô§"><TrashIcon /></button>
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    </div>

                    {/* Preview Area */}
                    <div className="flex-1 bg-gray-300/50 rounded-xl overflow-hidden shadow-inner flex flex-col md:h-[calc(100vh-2rem)] h-[500px] border border-gray-200 relative">
                        <div className="bg-white border-b px-4 py-2 flex justify-between items-center text-xs text-gray-500 shadow-sm z-10">
                            <span>„Éó„É¨„Éì„É•„Éº ({layoutPages.length}„Éö„Éº„Ç∏)</span>
                            <span className="hidden md:inline">‚ÄªÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶È†ÜÁï™„ÇíÂÖ•„ÇåÊõø„Åà„Çâ„Çå„Åæ„Åô</span>
                            <span>{currentPaper.name} / {settings.unit === 'cm' ? 'cm' : 'mm'}</span>
                        </div>
                        
                        <main ref={previewContainerRef} className="flex-1 overflow-auto p-4 md:p-8 preview-scroll relative bg-gray-300/50">
                            <div className="flex flex-col gap-4 md:gap-8 items-center min-w-full pb-8">
                                {layoutPages.length === 0 && (
                                    <div 
                                        className="bg-white shadow-xl flex items-center justify-center text-gray-300 rounded-sm transition-transform duration-300 origin-top"
                                        style={{
                                            width: `${currentPaper.width * MM_TO_PX}px`,
                                            height: `${currentPaper.height * MM_TO_PX}px`,
                                            transform: `scale(${previewScale})`,
                                            marginBottom: `-${(1 - previewScale) * (currentPaper.height * MM_TO_PX)}px`
                                        }}
                                    >
                                        <div className="text-center">
                                            <p className="text-4xl mb-2">üìÑ</p>
                                            <p>„Åì„Åì„Å´„Éó„É¨„Éì„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                                        </div>
                                    </div>
                                )}

                                {layoutPages.map((pageItems, pIndex) => (
                                    <div 
                                        key={pIndex} 
                                        className="relative origin-top transition-transform duration-300"
                                        style={{
                                            width: `${currentPaper.width * MM_TO_PX}px`,
                                            height: `${currentPaper.height * MM_TO_PX}px`,
                                            transform: `scale(${previewScale})`,
                                            marginBottom: pIndex === layoutPages.length - 1 ? 0 : `-${(1 - previewScale) * (currentPaper.height * MM_TO_PX)}px`
                                        }}
                                    >
                                        <div className="bg-white shadow-xl relative h-full w-full">
                                            {/* „Ç¨„Ç§„Éâ„É©„Ç§„É≥ */}
                                            {settings.showGuides && (
                                                <div className="absolute border border-blue-200 pointer-events-none opacity-20"
                                                    style={{
                                                        left: `${settings.margin * MM_TO_PX}px`,
                                                        top: `${settings.margin * MM_TO_PX}px`,
                                                        width: `calc(100% - ${settings.margin * 2 * MM_TO_PX}px)`,
                                                        height: `calc(100% - ${settings.margin * 2 * MM_TO_PX}px)`,
                                                    }}
                                                />
                                            )}

                                            {/* „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å™ÁîªÂÉèÁæ§ */}
                                            {pageItems.map((item) => (
                                                <PreviewImage 
                                                    key={item.id}
                                                    item={item}
                                                    settings={settings}
                                                    previewScale={previewScale}
                                                    MM_TO_PX={MM_TO_PX}
                                                    onRotate={rotateImage}
                                                    onRemove={removeImage}
                                                    onDragStart={handleDragStart}
                                                    onDragOver={handleDragOver}
                                                    onDrop={handleDrop}
                                                    draggedIndex={draggedIndex}
                                                />
                                            ))}
                                        </div>
                                        <div className="absolute -bottom-10 w-full text-center text-lg text-gray-500 font-medium pointer-events-none">
                                            {currentPaper.name} - Page {pIndex + 1}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
