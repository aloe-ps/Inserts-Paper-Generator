<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç§„É≥„Çµ„Éº„ÉàÈÖçÁΩÆÔºÜPDFÁîüÊàê„ÉÑ„Éº„É´</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            /* Prevent pull-to-refresh on mobile if needed, but usually default is fine */
        }
        .preview-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .preview-scroll::-webkit-scrollbar-track {
            background: #e5e7eb; 
        }
        .preview-scroll::-webkit-scrollbar-thumb {
            background: #9ca3af; 
            border-radius: 4px;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Constants ---
        const PAPER_SIZES = {
            'a4': { name: 'A4', width: 210, height: 297 },
            'a5': { name: 'A5', width: 148, height: 210 },
            'b4': { name: 'B4 (JIS)', width: 257, height: 364 },
            'b5': { name: 'B5 (JIS)', width: 182, height: 257 },
            'letter': { name: 'Letter', width: 216, height: 279 },
            'postcard': { name: '„Éè„Ç¨„Ç≠', width: 100, height: 148 }
        };

        // 1mm ‚âí 3.78px (96dpi) - used for preview scaling logic only
        const MM_TO_PX = 3.7795;

        // --- Icons ---
        const TrashIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
        );

        const FileIcon = () => (
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
        );

        const DownloadIcon = () => (
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
        );

        const LoaderIcon = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );
        
        const RotateIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        );

        // --- Components ---

        const NumberStepper = ({ value, onChange, step, min = 0, unitLabel }) => {
            const handleDecrement = () => {
                const current = parseFloat(value) || 0;
                const stepNum = parseFloat(step) || 1;
                let newVal = current - stepNum;
                if (newVal < min) newVal = min;
                const precision = step.toString().split('.')[1]?.length || 0;
                onChange(Number(newVal.toFixed(precision)));
            };

            const handleIncrement = () => {
                const current = parseFloat(value) || 0;
                const stepNum = parseFloat(step) || 1;
                const newVal = current + stepNum;
                const precision = step.toString().split('.')[1]?.length || 0;
                onChange(Number(newVal.toFixed(precision)));
            };

            return (
                <div className="flex items-center w-full border border-gray-300 rounded focus-within:ring-2 focus-within:ring-blue-500 overflow-hidden bg-white shadow-sm">
                    <button type="button" onClick={handleDecrement} className="w-10 h-10 flex items-center justify-center bg-gray-50 text-gray-500 hover:bg-gray-200 border-r border-gray-300 transition-colors focus:outline-none">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <input type="number" step={step} min={min} value={value} onChange={(e) => onChange(e.target.value)} className="w-full h-10 text-center text-gray-700 font-medium focus:outline-none" />
                    <button type="button" onClick={handleIncrement} className="w-10 h-10 flex items-center justify-center bg-gray-50 text-gray-500 hover:bg-gray-200 border-l border-gray-300 transition-colors focus:outline-none">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    {unitLabel && <div className="bg-gray-100 border-l border-gray-300 px-2 h-10 flex items-center justify-center text-xs text-gray-500 w-10 flex-shrink-0 font-medium select-none">{unitLabel}</div>}
                </div>
            );
        };

        const App = () => {
            const [images, setImages] = useState([]);
            const [isDragging, setIsDragging] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            
            const [settings, setSettings] = useState({
                paperSize: 'a4',
                targetHeight: 50,
                margin: 15,
                gap: 5,
                showGuides: true,
                unit: 'cm'
            });

            // For mobile scaling
            const [previewScale, setPreviewScale] = useState(1);
            const previewContainerRef = useRef(null);

            const currentPaper = PAPER_SIZES[settings.paperSize];

            const toDisplay = (valMm) => settings.unit === 'cm' ? parseFloat((valMm / 10).toFixed(2)) : Math.round(valMm);
            const fromDisplay = (val) => settings.unit === 'cm' ? val * 10 : val;

            const handleSettingChange = (key, displayValue) => {
                const numVal = parseFloat(displayValue);
                if (isNaN(numVal)) return;
                setSettings(prev => ({ ...prev, [key]: fromDisplay(numVal) }));
            };

            const toggleUnit = () => {
                setSettings(prev => ({ ...prev, unit: prev.unit === 'mm' ? 'cm' : 'mm' }));
            };

            // Responsive Scaling Logic
            useEffect(() => {
                const calculateScale = () => {
                    if (!previewContainerRef.current) return;
                    
                    const containerWidth = previewContainerRef.current.clientWidth;
                    // Padding (p-8 in PC, p-4 in mobile)
                    const padding = window.innerWidth < 768 ? 32 : 64; 
                    const availableWidth = containerWidth - padding;
                    
                    const paperWidthPx = currentPaper.width * MM_TO_PX;
                    
                    // Scale to fit width if paper is wider than container
                    let newScale = availableWidth / paperWidthPx;
                    
                    // Don't scale up too much on huge screens, but keep it readable
                    // Allow shrinking for mobile
                    if (newScale > 1) newScale = 1; 
                    
                    setPreviewScale(newScale);
                };

                // Initial calc
                calculateScale();

                // Add resize listener
                window.addEventListener('resize', calculateScale);
                return () => window.removeEventListener('resize', calculateScale);
            }, [currentPaper, settings.paperSize]); // Re-calc when paper size changes

            // CanvasHelper: Rotate Image
            const createRotatedImage = (imgSource, angle = 90) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const isPortrait = angle % 180 === 0;
                    if (isPortrait) {
                         canvas.width = imgSource.width;
                         canvas.height = imgSource.height;
                    } else {
                         canvas.width = imgSource.height;
                         canvas.height = imgSource.width;
                    }
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(angle * Math.PI / 180);
                    ctx.drawImage(imgSource, -imgSource.width / 2, -imgSource.height / 2);
                    resolve({
                        preview: canvas.toDataURL('image/jpeg', 0.90),
                        width: canvas.width,
                        height: canvas.height
                    });
                });
            };

            const handleFiles = async (files) => {
                const fileList = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (fileList.length === 0) return;

                const loadedImages = await Promise.all(fileList.map(file => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        const rawUrl = URL.createObjectURL(file);
                        
                        img.onload = async () => {
                            let resultPreview = rawUrl;
                            let resultW = img.naturalWidth;
                            let resultH = img.naturalHeight;

                            if (resultW > resultH) {
                                const rotated = await createRotatedImage(img, 90);
                                resultPreview = rotated.preview;
                                resultW = rotated.width;
                                resultH = rotated.height;
                                URL.revokeObjectURL(rawUrl); 
                            }

                            resolve({
                                file,
                                id: Math.random().toString(36).substr(2, 9),
                                preview: resultPreview,
                                name: file.name,
                                width: resultW,
                                height: resultH,
                                aspectRatio: resultW / resultH
                            });
                        };
                        img.src = rawUrl;
                    });
                }));
                
                setImages(prev => [...prev, ...loadedImages]);
            };

            const rotateImage = async (id) => {
                const targetIndex = images.findIndex(img => img.id === id);
                if (targetIndex === -1) return;
                const targetImg = images[targetIndex];
                const imgObj = new Image();
                imgObj.src = targetImg.preview;
                await new Promise(r => imgObj.onload = r);
                const rotated = await createRotatedImage(imgObj, 90);
                setImages(prev => {
                    const next = [...prev];
                    next[targetIndex] = {
                        ...targetImg,
                        preview: rotated.preview,
                        width: rotated.width,
                        height: rotated.height,
                        aspectRatio: rotated.width / rotated.height
                    };
                    return next;
                });
            };

            const removeImage = (id) => {
                setImages(prev => {
                    const target = prev.find(img => img.id === id);
                    if (target && target.preview.startsWith('blob:')) URL.revokeObjectURL(target.preview);
                    return prev.filter(img => img.id !== id);
                });
            };

            const layoutPages = useMemo(() => {
                const pageW = currentPaper.width;
                const pageH = currentPaper.height;
                const margin = settings.margin;
                const gap = settings.gap;
                const targetH = settings.targetHeight;

                const contentW = pageW - (margin * 2);
                const contentH = pageH - (margin * 2);

                let pages = [];
                let currentPageItems = [];
                let currentX = 0;
                let currentY = 0;

                const finalizePage = () => {
                    if (currentPageItems.length > 0) {
                        pages.push(currentPageItems);
                    }
                    currentPageItems = [];
                    currentX = 0;
                    currentY = 0;
                };

                images.forEach((img) => {
                    const printH = targetH;
                    const printW = targetH * img.aspectRatio;

                    if (currentX + printW > contentW && currentX > 0) {
                        currentX = 0;
                        currentY += targetH + gap;
                    }

                    if (currentY + targetH > contentH) {
                        finalizePage();
                    }

                    currentPageItems.push({
                        ...img,
                        x: currentX,
                        y: currentY,
                        w: printW,
                        h: printH
                    });

                    currentX += printW + gap;
                });

                if (currentPageItems.length > 0) {
                    pages.push(currentPageItems);
                }

                return pages;
            }, [images, settings, currentPaper]);


            const generatePDF = async () => {
                if (images.length === 0) return;
                setIsGenerating(true);

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'p',
                        unit: 'mm',
                        format: [currentPaper.width, currentPaper.height] 
                    });

                    const margin = settings.margin;

                    for (let pIndex = 0; pIndex < layoutPages.length; pIndex++) {
                        const pageItems = layoutPages[pIndex];
                        if (pIndex > 0) {
                             doc.addPage([currentPaper.width, currentPaper.height]);
                        }

                        for (const item of pageItems) {
                            const imgObj = await new Promise((resolve) => {
                                const img = new Image();
                                img.onload = () => resolve(img);
                                img.src = item.preview;
                            });

                            const canvas = document.createElement('canvas');
                            canvas.width = imgObj.width;
                            canvas.height = imgObj.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(imgObj, 0, 0);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.90);

                            doc.addImage(
                                dataUrl, 
                                'JPEG', 
                                item.x + margin, 
                                item.y + margin, 
                                item.w, 
                                item.h
                            );
                        }
                    }

                    doc.save(`layout_${settings.paperSize}.pdf`);

                } catch (e) {
                    console.error(e);
                    alert("PDF‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
                } finally {
                    setIsGenerating(false);
                }
            };

            const displayUnit = settings.unit;

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto p-2 md:p-4 gap-4 md:gap-6">
                    
                    {/* Controls (Sidebar on Desktop, Top on Mobile) */}
                    <div className="w-full md:w-80 flex flex-col gap-4 md:gap-6 bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 h-fit md:sticky md:top-4 z-20">
                        <header>
                            <h1 className="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                                <FileIcon />
                                „Ç§„É≥„Çµ„Éº„ÉàPDF
                            </h1>
                            <p className="text-xs text-gray-500 mt-1">„Çπ„Éû„Éõ„ÉªPC‰∏°ÂØæÂøú„É¨„Ç§„Ç¢„Ç¶„Éà„ÉÑ„Éº„É´</p>
                        </header>

                        {/* Settings */}
                        <div className="space-y-4 border-t pt-4 border-gray-100">
                            <div className="flex justify-between items-center mb-2">
                                <h2 className="text-sm font-bold text-gray-700">„É¨„Ç§„Ç¢„Ç¶„ÉàË®≠ÂÆö</h2>
                                <button onClick={toggleUnit} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 font-medium transition">
                                    Âçò‰Ωç: {settings.unit}
                                </button>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-600 mb-1">Áî®Á¥ô„Çµ„Ç§„Ç∫</label>
                                <div className="relative">
                                    <select 
                                        value={settings.paperSize}
                                        onChange={(e) => setSettings(p => ({...p, paperSize: e.target.value}))}
                                        className="w-full h-10 pl-3 pr-8 border border-gray-300 rounded bg-white text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none cursor-pointer"
                                    >
                                        {Object.entries(PAPER_SIZES).map(([key, size]) => (
                                            <option key={key} value={key}>
                                                {size.name} ({size.width}√ó{size.height}mm)
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-600 mb-1">ÁîªÂÉè„ÅÆÈ´ò„Åï</label>
                                <NumberStepper 
                                    value={toDisplay(settings.targetHeight)}
                                    onChange={(val) => handleSettingChange('targetHeight', val)}
                                    step={displayUnit === 'cm' ? "0.1" : "1"}
                                    min={1}
                                    unitLabel={displayUnit}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 mb-1">‰ΩôÁôΩ</label>
                                    <NumberStepper 
                                        value={toDisplay(settings.margin)}
                                        onChange={(val) => handleSettingChange('margin', val)}
                                        step={displayUnit === 'cm' ? "0.1" : "1"}
                                        min={0}
                                        unitLabel={displayUnit}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 mb-1">ÈñìÈöî</label>
                                    <NumberStepper 
                                        value={toDisplay(settings.gap)}
                                        onChange={(val) => handleSettingChange('gap', val)}
                                        step={displayUnit === 'cm' ? "0.1" : "1"}
                                        min={0}
                                        unitLabel={displayUnit}
                                    />
                                </div>
                            </div>

                            <div className="pt-2">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked={settings.showGuides} onChange={(e) => setSettings(p => ({...p, showGuides: e.target.checked}))} className="rounded text-blue-600 focus:ring-blue-500" />
                                    <span className="text-sm text-gray-600">Êû†Á∑ö„ÇíË°®Á§∫</span>
                                </label>
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="space-y-3 pt-2">
                            <label className={`
                                flex items-center justify-center w-full p-3 rounded-lg border-2 border-dashed cursor-pointer transition-colors
                                ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400 hover:bg-gray-50'}
                            `}
                            onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                            onDragLeave={(e) => { e.preventDefault(); setIsDragging(false); }}
                            onDrop={(e) => { e.preventDefault(); setIsDragging(false); handleFiles(e.dataTransfer.files); }}
                            >
                                <input type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleFiles(e.target.files)} />
                                <div className="text-center">
                                    <span className="text-sm font-medium text-gray-600 block">ÂÜôÁúü„ÇíËøΩÂä†</span>
                                    <span className="text-xs text-gray-400">„ÇØ„É™„ÉÉ„ÇØ „Åæ„Åü„ÅØ „Éâ„É©„ÉÉ„Ç∞</span>
                                </div>
                            </label>

                            <button 
                                onClick={generatePDF}
                                disabled={images.length === 0 || isGenerating}
                                className={`
                                    w-full py-3 px-4 rounded-lg font-bold text-white flex items-center justify-center shadow-md transition-all
                                    ${images.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 active:scale-[0.98]'}
                                `}
                            >
                                {isGenerating ? <LoaderIcon /> : <DownloadIcon />}
                                {isGenerating ? 'ÁîüÊàê‰∏≠...' : 'PDF„Çí‰ΩúÊàê'}
                            </button>
                        </div>
                        
                        {/* File List (Collapsible on mobile maybe? For now just show) */}
                        <div className="flex-1 overflow-y-auto max-h-[150px] md:max-h-none md:min-h-[100px] border-t pt-4">
                             <div className="flex justify-between items-center mb-2">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider">ÁîªÂÉè‰∏ÄË¶ß ({images.length})</h3>
                                {images.length > 0 && (
                                    <button onClick={() => setImages([])} className="text-xs text-red-400 hover:text-red-600">ÂÖ®ÂâäÈô§</button>
                                )}
                             </div>
                             <div className="space-y-2">
                                {images.map((img) => (
                                    <div key={img.id} className="flex items-center gap-3 bg-gray-50 p-2 rounded border border-gray-100 group">
                                        <img src={img.preview} alt="" className="w-8 h-8 object-cover rounded bg-white" />
                                        <div className="flex-1 min-w-0">
                                            <p className="text-xs text-gray-700 truncate">{img.name}</p>
                                        </div>
                                        <div className="flex gap-1 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => rotateImage(img.id)} className="text-gray-400 hover:text-blue-500 p-1" title="ÂõûËª¢"><RotateIcon /></button>
                                            <button onClick={() => removeImage(img.id)} className="text-gray-400 hover:text-red-500 p-1" title="ÂâäÈô§"><TrashIcon /></button>
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    </div>

                    {/* Preview Area (Paginated) */}
                    <div className="flex-1 bg-gray-300/50 rounded-xl overflow-hidden shadow-inner flex flex-col md:h-[calc(100vh-2rem)] h-[500px] border border-gray-200">
                        <div className="bg-white border-b px-4 py-2 flex justify-between items-center text-xs text-gray-500 shadow-sm z-10">
                            <span>„Éó„É¨„Éì„É•„Éº ({layoutPages.length}„Éö„Éº„Ç∏)</span>
                            <span>{currentPaper.name} / {settings.unit === 'cm' ? 'cm' : 'mm'}</span>
                        </div>
                        
                        {/* Scrollable Container */}
                        <main 
                            ref={previewContainerRef}
                            className="flex-1 overflow-auto p-4 md:p-8 preview-scroll relative bg-gray-300/50"
                        >
                            <div className="flex flex-col gap-4 md:gap-8 items-center min-w-full pb-8">
                                
                                {layoutPages.length === 0 && (
                                    <div 
                                        className="bg-white shadow-xl flex items-center justify-center text-gray-300 rounded-sm transition-transform duration-300 origin-top"
                                        style={{
                                            width: `${currentPaper.width * MM_TO_PX}px`,
                                            height: `${currentPaper.height * MM_TO_PX}px`,
                                            transform: `scale(${previewScale})`,
                                            marginBottom: `-${(1 - previewScale) * (currentPaper.height * MM_TO_PX)}px` // Fix excess whitespace when scaled down
                                        }}
                                    >
                                        <div className="text-center">
                                            <p className="text-4xl mb-2">üìÑ</p>
                                            <p>„Åì„Åì„Å´„Éó„É¨„Éì„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                                            <p className="text-sm mt-1">({currentPaper.name})</p>
                                        </div>
                                    </div>
                                )}

                                {layoutPages.map((pageItems, pIndex) => (
                                    <div 
                                        key={pIndex} 
                                        className="relative origin-top transition-transform duration-300"
                                        style={{
                                            width: `${currentPaper.width * MM_TO_PX}px`,
                                            height: `${currentPaper.height * MM_TO_PX}px`,
                                            transform: `scale(${previewScale})`,
                                            // Scaled margin trick to reduce gap between pages when scaled
                                            marginBottom: pIndex === layoutPages.length - 1 ? 0 : `-${(1 - previewScale) * (currentPaper.height * MM_TO_PX)}px`
                                        }}
                                    >
                                        {/* Page with dynamic size */}
                                        <div 
                                            className="bg-white shadow-xl relative overflow-hidden h-full w-full"
                                        >
                                            {/* Render Items */}
                                            {pageItems.map((item) => (
                                                <div 
                                                    key={item.id}
                                                    className="absolute group transition-all duration-300"
                                                    style={{
                                                        // Convert mm coordinates to px for preview
                                                        left: `${(item.x + settings.margin) * MM_TO_PX}px`,
                                                        top: `${(item.y + settings.margin) * MM_TO_PX}px`,
                                                        width: `${item.w * MM_TO_PX}px`,
                                                        height: `${item.h * MM_TO_PX}px`,
                                                    }}
                                                >
                                                    <img 
                                                        src={item.preview} 
                                                        className="w-full h-full object-contain bg-gray-50"
                                                        style={{
                                                            outline: settings.showGuides ? '1px dashed #cbd5e1' : 'none'
                                                        }}
                                                    />
                                                    
                                                    {/* „Éõ„Éê„ÉºÊôÇ„ÅÆÊìç‰Ωú„Éú„Çø„É≥ („Çπ„Éû„Éõ„Åß„ÅØÂ∏∏ÊôÇË°®Á§∫„Å´Ëøë„ÅÑÂΩ¢„ÅåËâØ„ÅÑ„Åå„ÄÅ„Çø„ÉÉ„Éó„ÅßÂá∫„Çã„Çà„ÅÜ„Å´ÈÄèÊòéÂ∫¶Ë™øÊï¥) */}
                                                    <div className="absolute top-0 right-0 p-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity flex gap-1">
                                                        <button 
                                                            onClick={() => rotateImage(item.id)}
                                                            className="bg-white/90 text-gray-600 rounded shadow p-1 hover:text-blue-600 hover:bg-white transform active:scale-95 z-10"
                                                            title="ÂõûËª¢"
                                                        >
                                                            <RotateIcon />
                                                        </button>
                                                        <button 
                                                            onClick={() => removeImage(item.id)}
                                                            className="bg-red-500/90 text-white rounded shadow p-1 hover:bg-red-600 transform active:scale-95 z-10"
                                                            title="ÂâäÈô§"
                                                        >
                                                            <TrashIcon />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}

                                            {/* Margins Guide (Visual Aid) */}
                                            {settings.showGuides && (
                                                <div 
                                                    className="absolute border border-blue-200 pointer-events-none opacity-20"
                                                    style={{
                                                        left: `${settings.margin * MM_TO_PX}px`,
                                                        top: `${settings.margin * MM_TO_PX}px`,
                                                        width: `calc(100% - ${settings.margin * 2 * MM_TO_PX}px)`,
                                                        height: `calc(100% - ${settings.margin * 2 * MM_TO_PX}px)`,
                                                    }}
                                                />
                                            )}
                                        </div>
                                        
                                        {/* Page Number (Outside the scaled div but positioned relative to it, need to handle scaling) */}
                                        <div 
                                            className="absolute -bottom-10 w-full text-center text-lg text-gray-500 font-medium"
                                            style={{
                                                // Counter-scale text to keep it readable? Or just let it scale. Let it scale is easier.
                                                // Actually, if we scale the parent div, this scales too.
                                            }}
                                        >
                                            {currentPaper.name} - Page {pIndex + 1}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
